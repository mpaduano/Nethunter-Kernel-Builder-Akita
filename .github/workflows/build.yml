name: Build Pixel 8a Kernel (Bazel)

env:
  CONFIGURATION: repos.json
  KERNEL_DIR: kernel

on:
  workflow_dispatch:

jobs:
  parse-repos:
    name: ðŸ“œ Parse repos.json
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”Ž Generate matrix
        id: set-matrix
        run: |
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          cat $CONFIGURATION >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build:
    name: ðŸ§± Bazel Kernel Build
    runs-on: ubuntu-22.04
    needs: parse-repos
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.parse-repos.outputs.matrix) }}

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ§° Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison flex libssl-dev \
            build-essential git zip unzip \
            python3 python3-pip curl rsync \
            libelf-dev dwarves jq

      - name: ðŸ›  Install Bazel
        run: |
          curl -LO https://github.com/bazelbuild/bazel/releases/download/6.5.0/bazel-6.5.0-linux-x86_64
          chmod +x bazel-6.5.0-linux-x86_64
          sudo mv bazel-6.5.0-linux-x86_64 /usr/local/bin/bazel
          bazel --version

      - name: ðŸ§¬ Clone kernel sources
        run: |
          mkdir -p $KERNEL_DIR
          cd $KERNEL_DIR

          git clone \
            -b ${{ matrix.kernelSources.common.branch }} \
            ${{ matrix.kernelSources.common.repo }} \
            common

          git clone \
            -b ${{ matrix.kernelSources.modules.branch }} \
            ${{ matrix.kernelSources.modules.repo }} \
            google-modules

          git clone \
            -b ${{ matrix.kernelSources.device.branch }} \
            ${{ matrix.kernelSources.device.repo }} \
            google-devices/akita
            
      - name: ðŸ§© Fix Bazel workspace
        run: |
          cd kernel
          cp common/WORKSPACE .

      - name: ðŸš€ Build kernel with Bazel
        working-directory: kernel
        run: |
          bazel build \
          --config=fast \
          //common:kernel_aarch64_dist

      - name: ðŸ“¦ Collect artifacts
        run: |
          mkdir -p out

          DIST_DIR=kernel/common/bazel-bin/common/kernel_aarch64_dist
          ls -lah $DIST_DIR || true

          cp $DIST_DIR/Image out/ 2>/dev/null || true
          cp $DIST_DIR/vmlinux out/ 2>/dev/null || true
          cp $DIST_DIR/*.img out/ 2>/dev/null || true

      - name: ðŸ’¾ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pixel8a-android15-6.1-kernel
          path: out/
          retention-days: 7
